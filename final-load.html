<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Final Load Entry</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f6fb;
      padding: 30px;
    }
    h1, h2 {
      color: #2d58a4;
    }
    .info-box {
      margin-bottom: 20px;
      padding: 12px;
      background: #e9eff8;
      border-left: 4px solid #2d58a4;
    }
    input {
      padding: 6px;
      margin: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
      background: #2d58a4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1e3d7b;
    }
    .btn-red {
      background: #e74c3c;
    }
    .btn-gray {
      background: #888;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .uld-block {
      margin-top: 30px;
      background: #fff;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <button onclick="history.back()" style="margin-bottom: 10px;">üîô Back</button>
  <h1>Final Load Entry</h1>
  <div class="info-box" id="flight-info">Loading flight info...</div>

  <h2>Add AWB to ULD</h2>
  <input type="text" id="uldNo" placeholder="ULD No" />
  <input type="text" id="awbNo" placeholder="AWB No" />
  <input type="number" id="qty" placeholder="PCS" />
  <input type="number" id="weight" placeholder="Weight (kg)" />
  <button onclick="addAWB()">+ Add AWB</button>

  <div id="uldArea"></div>

  <button onclick="goToSummary()">üìä View Summary Report</button>
  <button onclick="saveToSupabase()">üíæ Save to Supabase</button>

  <script>
    const sb = supabase.createClient(
      'https://xgaforpzjrievucwlgla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnYWZvcnB6anJpZXZ1Y3dsZ2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTEyMDQsImV4cCI6MjA2OTAyNzIwNH0.QPUOtbCPdxrqiWr93yp7FsxznzSyA_Je1oF4D65rzXs'
    );

    const params = new URLSearchParams(window.location.search);
    const flightInfo = {
      year: params.get('year'),
      month: params.get('month'),
      monthText: params.get('monthText'),
      day: params.get('day'),
      flight: params.get('flight')
    };

    document.getElementById('flight-info').innerText =
      `Flight ${flightInfo.flight} on ${flightInfo.day}-${flightInfo.monthText}-${flightInfo.year}`;

    const uldMap = {}; // { uldNo: [{awbNo, qty, weight}] }

    function addAWB() {
      const uldNo = document.getElementById('uldNo').value.trim().toUpperCase();
      const awbNo = document.getElementById('awbNo').value.trim();
      const qty = document.getElementById('qty').value.trim();
      const weight = document.getElementById('weight').value.trim();

      if (!uldNo || !awbNo || !qty || !weight) {
        alert("Please fill all fields.");
        return;
      }

      if (!uldMap[uldNo]) uldMap[uldNo] = [];
      uldMap[uldNo].push({ awbNo, qty, weight });
      renderULDs();

      document.getElementById('awbNo').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('weight').value = '';
    }

    function renderULDs() {
      const area = document.getElementById('uldArea');
      area.innerHTML = '';

      Object.keys(uldMap).forEach(uld => {
        const block = document.createElement('div');
        block.className = 'uld-block';

        const header = document.createElement('h3');
        header.textContent = `ULD: ${uld}`;
        block.appendChild(header);

        const table = document.createElement('table');
        table.innerHTML = `
          <thead><tr><th>AWB No</th><th>PCS</th><th>Weight</th></tr></thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        uldMap[uld].forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.awbNo}</td>
            <td>${entry.qty}</td>
            <td>${entry.weight}</td>
          `;
          tbody.appendChild(row);
        });

        block.appendChild(table);
        area.appendChild(block);
      });
    }

    function goToSummary() {
      localStorage.setItem('flightInfo', JSON.stringify(flightInfo));
      localStorage.setItem('uldData', JSON.stringify(uldMap));
      window.location.href = 'cargo-summary.html';
    }

    async function saveToSupabase() {
      const { flight, day, monthText, year } = flightInfo;
      const origin = "DMK";
      const destination = "CGK";
      const flightDate = `${year}-${monthTextToNumber(monthText)}-${day.padStart(2, '0')}`;
      const stdTime = "00:00:00";

      const flightRes = await sb.from("flights").insert({
        flight_no: flight,
        flight_date: flightDate,
        origin,
        destination,
        std: stdTime
      }).select();

      const flightId = flightRes.data?.[0]?.id;
      if (!flightId) return alert("‚ùå Failed to save flight.");

      for (const uldNo in uldMap) {
        const uldRes = await sb.from("ulds").insert({
          flight_id: flightId,
          uld_no: uldNo,
          reg: "",
          shc: ""
        }).select();

        const uldId = uldRes.data?.[0]?.id;
        if (!uldId) continue;

        for (const awb of uldMap[uldNo]) {
          await sb.from("awbs").insert({
            uld_id: uldId,
            awb_no: awb.awbNo,
            pcs: parseInt(awb.qty),
            weight: parseFloat(awb.weight),
            destination: destination,
            part: "",
            shc: ""
          });
        }
      }

      alert("‚úÖ Saved all data to Supabase!");
    }

    function monthTextToNumber(text) {
      const map = {
        JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
        JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
      };
      return map[text.toUpperCase()] || "01";
    }
  </script>
</body>
</html>
