<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Final Load Entry</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f6fb;
      padding: 30px;
    }
    h1, h2 {
      color: #2d58a4;
    }
    .info-box {
      margin-bottom: 20px;
      padding: 12px;
      background: #e9eff8;
      border-left: 4px solid #2d58a4;
    }
    input {
      padding: 6px;
      margin: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
      background: #2d58a4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1e3d7b;
    }
    .btn-red {
      background: #e74c3c;
    }
    .btn-gray {
      background: #888;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .uld-block {
      margin-top: 30px;
      background: #fff;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <button onclick="history.back()" style="margin-bottom: 10px;">üîô Back</button>
  <h1>Final Load Entry</h1>
  <div class="info-box" id="flight-info">Loading flight info...</div>

  <h2>Add AWB to ULD</h2>
  <input type="text" id="uldNo" placeholder="ULD No" />
  <input type="text" id="awbNo" placeholder="AWB No" />
  <input type="number" id="qty" placeholder="PCS" />
  <input type="number" id="weight" placeholder="Weight (kg)" />
  <button onclick="addAWB()">+ Add AWB</button>

  <div id="uldArea"></div>

  <button onclick="goToSummary()">üìä View Summary Report</button>
  <button onclick="saveToSupabase()">üíæ Save to Supabase</button>

  <script>
    const sb = supabase.createClient(
      'https://xgaforpzjrievucwlgla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnYWZvcnB6anJpZXZ1Y3dsZ2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTEyMDQsImV4cCI6MjA2OTAyNzIwNH0.QPUOtbCPdxrqiWr93yp7FsxznzSyA_Je1oF4D65rzXs'
    );

    const params = new URLSearchParams(window.location.search);
    const flightInfo = {
      year: params.get('year'),
      month: params.get('month'),
      monthText: params.get('monthText'),
      day: params.get('day'),
      flight: params.get('flight')
    };

    let flightId = null;
    const uldMap = {};

    document.getElementById('flight-info').innerText =
      `Flight ${flightInfo.flight} on ${flightInfo.day}-${flightInfo.monthText}-${flightInfo.year}`;

    async function loadInitialULDs() {
      const flightDate = `${flightInfo.year}-${flightInfo.month}-${flightInfo.day}`;
      const { data: flightData } = await sb
        .from("flights")
        .select("id")
        .eq("flight_no", flightInfo.flight)
        .eq("flight_date", flightDate)
        .single();

      if (!flightData) return;
      flightId = flightData.id;

      const { data: ulds } = await sb
        .from("ulds")
        .select("id, uld_no")
        .eq("flight_id", flightId);

      for (const uld of ulds) {
        const { data: awbs } = await sb
          .from("awbs")
          .select("awb_no, pcs, weight")
          .eq("uld_id", uld.id);

        uldMap[uld.uld_no] = (awbs || []).map(a => ({
          awbNo: a.awb_no,
          qty: a.pcs,
          weight: a.weight
        }));
      }

      renderULDs();
    }

    function addAWB() {
      const uldNo = document.getElementById('uldNo').value.trim().toUpperCase();
      const awbNo = document.getElementById('awbNo').value.trim();
      const qty = document.getElementById('qty').value.trim();
      const weight = document.getElementById('weight').value.trim();

      if (!uldNo || !awbNo || !qty || !weight) {
        alert("Please fill all fields.");
        return;
      }

      if (!uldMap[uldNo]) uldMap[uldNo] = [];
      uldMap[uldNo].push({ awbNo, qty, weight });
      renderULDs();

      document.getElementById('awbNo').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('weight').value = '';
    }

    function renderULDs() {
      const area = document.getElementById('uldArea');
      area.innerHTML = '';

      Object.keys(uldMap).forEach(uld => {
        const block = document.createElement('div');
        block.className = 'uld-block';

        const header = document.createElement('h3');
        header.innerHTML = `ULD: ${uld}
          <button class="btn-gray" onclick="editULDName('${uld}')">‚úèÔ∏è Edit</button>
          <button class="btn-red" onclick="deleteULD('${uld}')">üóëÔ∏è Delete ULD</button>`;
        block.appendChild(header);

        const table = document.createElement('table');
        table.innerHTML = `
          <thead><tr><th>AWB No</th><th>PCS</th><th>Weight</th><th>Action</th></tr></thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        uldMap[uld].forEach((entry, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.awbNo}</td>
            <td>${entry.qty}</td>
            <td>${entry.weight}</td>
            <td>
              <button onclick="editAWB('${uld}', ${i})">‚úèÔ∏è</button>
              <button class="btn-red" onclick="deleteAWB('${uld}', ${i})">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        block.appendChild(table);
        area.appendChild(block);
      });
    }

    function editULDName(oldUldNo) {
      const newName = prompt("Enter new ULD No", oldUldNo);
      if (newName && newName !== oldUldNo) {
        uldMap[newName] = uldMap[oldUldNo];
        delete uldMap[oldUldNo];
        renderULDs();
        document.getElementById('uldNo').value = newName;
      }
    }

    function deleteULD(uldNo) {
      if (confirm(`Delete entire ULD ${uldNo}?`)) {
        delete uldMap[uldNo];
        renderULDs();
      }
    }

    function deleteAWB(uldNo, index) {
      if (confirm("Delete this AWB?")) {
        uldMap[uldNo].splice(index, 1);
        if (uldMap[uldNo].length === 0) delete uldMap[uldNo];
        renderULDs();
      }
    }

    function editAWB(uldNo, index) {
      const entry = uldMap[uldNo][index];
      const modal = document.createElement('div');
      modal.id = 'awb-edit-modal';
      modal.style.position = 'fixed';
      modal.style.top = '30%';
      modal.style.left = '50%';
      modal.style.transform = 'translate(-50%, -30%)';
      modal.style.background = '#fff';
      modal.style.border = '1px solid #ccc';
      modal.style.padding = '16px';
      modal.style.zIndex = 1000;
      modal.innerHTML = `
        <div style="font-family:Segoe UI;">
          <label>AWB No: <input id="edit-awb" value="${entry.awbNo}" /></label><br/>
          <label>PCS: <input id="edit-qty" type="number" value="${entry.qty}" /></label><br/>
          <label>Weight (kg): <input id="edit-weight" type="number" value="${entry.weight}" /></label><br/><br/>
          <button onclick="applyEdit('${uldNo}', ${index})">Save</button>
          <button onclick="document.body.removeChild(this.parentNode.parentNode)">Cancel</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function applyEdit(uldNo, index) {
      const awb = document.getElementById('edit-awb').value.trim();
      const qty = document.getElementById('edit-qty').value.trim();
      const weight = document.getElementById('edit-weight').value.trim();

      if (awb) uldMap[uldNo][index].awbNo = awb;
      if (qty) uldMap[uldNo][index].qty = qty;
      if (weight) uldMap[uldNo][index].weight = weight;

      const modal = document.getElementById('awb-edit-modal');
      if (modal) document.body.removeChild(modal);
      renderULDs();
    }

    function goToSummary() {
      localStorage.setItem('flightInfo', JSON.stringify(flightInfo));
      localStorage.setItem('uldData', JSON.stringify(uldMap));
      window.location.href = 'cargo-summary.html';
    }

    async function saveToSupabase() {
      const { flight, day, monthText, year } = flightInfo;
      const flightDate = `${year}-${monthTextToNumber(monthText)}-${day.padStart(2, '0')}`;
      const origin = "DMK";
      const destination = "CGK";
      const stdTime = "00:00:00";

      if (!flightId) {
        const res = await sb.from("flights").insert({
          flight_no: flight,
          flight_date: flightDate,
          origin,
          destination,
          std: stdTime
        }).select();
        flightId = res.data?.[0]?.id;
      }

      if (!flightId) return alert("‚ùå Failed to save flight.");

      for (const uldNo in uldMap) {
        const uldRes = await sb.from("ulds").insert({
          flight_id: flightId,
          uld_no: uldNo,
          reg: "",
          shc: ""
        }).select();

        const uldId = uldRes.data?.[0]?.id;
        if (!uldId) continue;

        for (const awb of uldMap[uldNo]) {
          await sb.from("awbs").insert({
            uld_id: uldId,
            awb_no: awb.awbNo,
            pcs: parseInt(awb.qty),
            weight: parseFloat(awb.weight),
            destination: destination,
            part: "",
            shc: ""
          });
        }
      }

      alert("‚úÖ Saved all data to Supabase!");
    }

    function monthTextToNumber(text) {
      const map = {
        JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
        JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
      };
      return map[text.toUpperCase()] || "01";
    }

    loadInitialULDs();
  </script>
</body>
</html>
